<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2d1b4e">
  <meta name="description" content="Generate humorous rhyming stories with AI-powered illustrations">
  <title>Whimsy Tales - AI Story Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #faf6f1;
      --parchment: #f5ede3;
      --warm-brown: #8b6914;
      --deep-purple: #2d1b4e;
      --soft-purple: #6b4d8a;
      --coral: #e8735f;
      --coral-light: #ffb5a7;
      --sage: #87a878;
      --gold: #d4a853;
      --ink: #2c2416;
      --font-display: 'Abril Fatface', serif;
      --font-body: 'Crimson Pro', serif;
      --font-ui: 'Fredoka', sans-serif;
    }

```
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: var(--font-body);
  background: linear-gradient(135deg, var(--cream) 0%, var(--parchment) 50%, #f8f0e6 100%);
  color: var(--ink);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* Background decoration */
.bg-decoration {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}

.bg-circle {
  position: absolute;
  border-radius: 50%;
  opacity: 0.15;
}

.bg-circle-1 {
  width: 60vw;
  height: 60vw;
  max-width: 600px;
  max-height: 600px;
  background: radial-gradient(circle, var(--coral) 0%, transparent 70%);
  top: -20%;
  right: -10%;
  animation: float 20s ease-in-out infinite;
}

.bg-circle-2 {
  width: 50vw;
  height: 50vw;
  max-width: 500px;
  max-height: 500px;
  background: radial-gradient(circle, var(--soft-purple) 0%, transparent 70%);
  bottom: -15%;
  left: -10%;
  animation: float 25s ease-in-out infinite reverse;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

/* Screens */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: clamp(1rem, 5vw, 2rem);
  z-index: 1;
  transition: opacity 0.4s ease, transform 0.4s ease;
}

.screen.hidden {
  opacity: 0;
  pointer-events: none;
  transform: scale(0.95);
}

/* ===== PROMPT SCREEN ===== */
.prompt-container {
  width: 100%;
  max-width: 550px;
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.logo-container {
  text-align: center;
  margin-bottom: 0.5rem;
}

.logo-icon {
  font-size: 2.5rem;
  animation: float 3s ease-in-out infinite;
  display: inline-block;
}

.logo-text {
  font-family: var(--font-display);
  font-size: clamp(2rem, 8vw, 3rem);
  color: var(--deep-purple);
  text-shadow: 2px 2px 0 var(--coral-light);
}

.tagline {
  font-family: var(--font-ui);
  font-size: 1rem;
  color: var(--soft-purple);
}

.api-key-button {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: var(--parchment);
  border: 2px dashed var(--soft-purple);
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 0.9rem;
  color: var(--soft-purple);
  cursor: pointer;
  transition: all 0.2s ease;
}

.api-key-button:hover {
  background: white;
  border-style: solid;
}

.api-key-button.has-key {
  background: #e8f5e9;
  border-color: var(--sage);
  border-style: solid;
  color: #2e7d32;
}

.top-buttons {
  display: flex;
  gap: 0.75rem;
}

.library-button {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: var(--parchment);
  border: 2px solid var(--warm-brown);
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 0.9rem;
  color: var(--warm-brown);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.library-button:hover {
  background: white;
  border-color: var(--gold);
  color: var(--gold);
}

.library-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--coral);
  color: white;
  font-size: 0.7rem;
  font-weight: 600;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== LIBRARY SCREEN ===== */
.library-screen {
  overflow-y: auto;
  padding-top: 1rem;
  padding-bottom: 2rem;
}

.library-container {
  width: 100%;
  max-width: 600px;
}

.library-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
}

.library-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 6vw, 2rem);
  color: var(--deep-purple);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.library-back {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 1rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  transition: all 0.2s ease;
}

.library-back:hover {
  background: var(--parchment);
}

.library-empty {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--soft-purple);
}

.library-empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.library-empty h3 {
  font-family: var(--font-display);
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
  color: var(--deep-purple);
}

.library-empty p {
  font-family: var(--font-body);
  font-size: 1rem;
}

.library-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 1rem;
}

.library-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.library-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.library-card-image {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  background: var(--parchment);
}

.library-card-placeholder {
  width: 100%;
  aspect-ratio: 1;
  background: linear-gradient(145deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
}

.library-card-info {
  padding: 0.75rem;
}

.library-card-title {
  font-family: var(--font-ui);
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.library-card-date {
  font-family: var(--font-ui);
  font-size: 0.7rem;
  color: #999;
  margin-top: 0.25rem;
}

.library-card-delete {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 28px;
  height: 28px;
  background: rgba(0, 0, 0, 0.6);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.library-card:hover .library-card-delete {
  opacity: 1;
}

.library-card-delete:hover {
  background: var(--coral);
}

/* Save button in book view */
.save-button {
  position: fixed;
  top: 0.75rem;
  right: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.75rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.save-button:hover {
  background: var(--parchment);
}

.save-button.saved {
  background: #e8f5e9;
  border-color: var(--sage);
  color: #2e7d32;
}

/* Toast notification */
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--ink);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.9rem;
  z-index: 2000;
  opacity: 0;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.prompt-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.prompt-label {
  font-family: var(--font-display);
  font-size: clamp(1.25rem, 4vw, 1.5rem);
  color: var(--ink);
  text-align: center;
}

.input-wrapper {
  position: relative;
}

.prompt-input {
  width: 100%;
  padding: 1rem;
  font-family: var(--font-body);
  font-size: 1.1rem;
  line-height: 1.5;
  color: var(--ink);
  background: white;
  border: 3px solid var(--parchment);
  border-radius: 16px;
  resize: none;
  transition: all 0.3s ease;
}

.prompt-input:focus {
  outline: none;
  border-color: var(--soft-purple);
  box-shadow: 0 4px 12px rgba(107, 77, 138, 0.15);
}

.char-count {
  position: absolute;
  bottom: 0.5rem;
  right: 1rem;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  color: #999;
}

.submit-button {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  padding: 1.25rem 2rem;
  background: linear-gradient(135deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  border: none;
  border-radius: 16px;
  font-family: var(--font-ui);
  font-size: 1.25rem;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(45, 27, 78, 0.3);
}

.submit-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(45, 27, 78, 0.4);
}

.submit-button:disabled {
  background: #ccc;
  cursor: not-allowed;
  box-shadow: none;
}

.api-hint {
  text-align: center;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--coral);
}

.error-message {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 1rem;
  background: #fff5f5;
  border: 1px solid #feb2b2;
  border-radius: 12px;
  color: #c53030;
  font-family: var(--font-ui);
  font-size: 0.9rem;
}

.sample-prompts {
  margin-top: 0.5rem;
}

.sample-label {
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  text-align: center;
  margin-bottom: 0.75rem;
}

.sample-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
}

.sample-chip {
  padding: 0.4rem 0.8rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 20px;
  font-family: var(--font-body);
  font-size: 0.8rem;
  color: var(--ink);
  cursor: pointer;
  transition: all 0.2s ease;
}

.sample-chip:hover {
  background: var(--coral-light);
  border-color: var(--coral);
  transform: translateY(-2px);
}

/* ===== LOADING SCREEN ===== */
.loading-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2rem;
}

.loading-book {
  width: 120px;
  height: 90px;
  position: relative;
  perspective: 600px;
}

.book-base {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  border-radius: 4px 12px 12px 4px;
  position: relative;
  box-shadow: -5px 5px 15px rgba(0, 0, 0, 0.2);
}

.book-base::before {
  content: '';
  position: absolute;
  left: 0;
  top: 5%;
  bottom: 5%;
  width: 8px;
  background: linear-gradient(90deg, var(--warm-brown) 0%, #a67c1a 50%, var(--warm-brown) 100%);
  border-radius: 2px 0 0 2px;
}

.loading-page {
  position: absolute;
  right: 5px;
  top: 5px;
  bottom: 5px;
  width: calc(100% - 20px);
  background: linear-gradient(90deg, #f5f0e8 0%, #fffef9 100%);
  border-radius: 0 8px 8px 0;
  transform-origin: left center;
  animation: flipPage 1.5s ease-in-out infinite;
}

.loading-page:nth-child(2) { animation-delay: 0.1s; }
.loading-page:nth-child(3) { animation-delay: 0.2s; }

@keyframes flipPage {
  0%, 100% { transform: rotateY(0deg); }
  50% { transform: rotateY(-25deg); }
}

.loading-message {
  font-family: var(--font-display);
  font-size: clamp(1.25rem, 5vw, 1.75rem);
  color: var(--deep-purple);
  text-align: center;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.loading-dots {
  display: flex;
  gap: 0.5rem;
}

.loading-dot {
  width: 10px;
  height: 10px;
  background: var(--coral);
  border-radius: 50%;
  animation: bounce 0.8s ease-in-out infinite;
}

.loading-dot:nth-child(2) { animation-delay: 0.15s; }
.loading-dot:nth-child(3) { animation-delay: 0.3s; }

@keyframes bounce {
  0%, 100% { transform: translateY(-3px); opacity: 0.3; }
  50% { transform: translateY(3px); opacity: 1; }
}

/* ===== BOOK SCREEN ===== */
.book-screen {
  padding: 0.5rem;
}

.back-button {
  position: fixed;
  top: 0.75rem;
  left: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.75rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.back-button:hover {
  background: var(--parchment);
}

.progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--parchment);
  z-index: 100;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--coral) 0%, var(--gold) 100%);
  transition: width 0.3s ease;
}

.book {
  position: relative;
  width: 100%;
  max-width: 500px;
  aspect-ratio: 3 / 4;
  margin: auto;
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
  touch-action: pan-x;
}

.book-spine {
  position: absolute;
  left: 0;
  top: 5%;
  bottom: 5%;
  width: 12px;
  background: linear-gradient(90deg, var(--warm-brown) 0%, #a67c1a 50%, var(--warm-brown) 100%);
  border-radius: 3px 0 0 3px;
  box-shadow: inset -2px 0 4px rgba(0, 0, 0, 0.3);
  z-index: 5;
}

.book-page {
  position: absolute;
  inset: 0;
  left: 12px;
  background: linear-gradient(135deg, #fffef9 0%, #faf8f3 50%, #f5f0e8 100%);
  border-radius: 0 12px 12px 0;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.15), 5px 5px 20px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: transform 0.4s ease, opacity 0.3s ease;
}

.book-page.turning-left {
  transform: translateX(-100%) rotateY(15deg);
  opacity: 0;
}

.book-page.turning-right {
  transform: translateX(100%) rotateY(-15deg);
  opacity: 0;
}

/* Cover page */
.cover-page {
  background: linear-gradient(145deg, var(--deep-purple) 0%, #3d2763 50%, var(--deep-purple) 100%);
  justify-content: center;
  align-items: center;
  padding: 2rem;
  color: white;
}

.cover-decoration {
  position: absolute;
  font-size: 1.5rem;
  color: var(--gold);
  opacity: 0.6;
}

.cover-decoration.tl { top: 1.5rem; left: 1.5rem; }
.cover-decoration.tr { top: 1.5rem; right: 1.5rem; }
.cover-decoration.bl { bottom: 1.5rem; left: 1.5rem; }
.cover-decoration.br { bottom: 1.5rem; right: 1.5rem; }

.book-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 6vw, 2.5rem);
  text-align: center;
  line-height: 1.2;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.cover-divider {
  font-size: 1.5rem;
  margin: 1rem 0;
  opacity: 0.5;
}

.book-subtitle {
  font-family: var(--font-body);
  font-size: 1.1rem;
  font-style: italic;
  opacity: 0.8;
}

.tap-hint {
  position: absolute;
  bottom: 1.5rem;
  left: 0;
  right: 0;
  text-align: center;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.5);
  animation: pulse 2s ease-in-out infinite;
}

/* Story page */
.story-page {
  padding: 1rem;
  gap: 0.75rem;
}

.page-image-container {
  flex: 1;
  min-height: 0;
  border-radius: 8px;
  overflow: hidden;
  background: var(--parchment);
}

.page-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.page-image-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--soft-purple);
  opacity: 0.5;
  font-size: 3rem;
}

.page-text-container {
  padding: 0.75rem 0.5rem;
  min-height: 25%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.page-text {
  font-family: var(--font-body);
  font-size: clamp(0.9rem, 3.5vw, 1.15rem);
  line-height: 1.6;
  text-align: center;
  color: var(--ink);
}

.page-number {
  position: absolute;
  bottom: 0.5rem;
  right: 1rem;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  color: var(--soft-purple);
  opacity: 0.5;
}

/* End page */
.end-page {
  background: linear-gradient(145deg, var(--sage) 0%, #6b9c5a 50%, var(--sage) 100%);
  justify-content: center;
  align-items: center;
  padding: 2rem;
  color: white;
  text-align: center;
}

.end-icon {
  font-size: 4rem;
  display: block;
  margin-bottom: 1rem;
  animation: float 3s ease-in-out infinite;
}

.end-title {
  font-family: var(--font-display);
  font-size: clamp(2rem, 8vw, 3rem);
  margin-bottom: 0.5rem;
}

.end-subtitle {
  font-family: var(--font-body);
  font-size: 1.1rem;
  font-style: italic;
  opacity: 0.9;
  margin-bottom: 2rem;
}

.new-story-button {
  padding: 1rem 2rem;
  background: white;
  border: none;
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 1rem;
  font-weight: 600;
  color: var(--sage);
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.new-story-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

/* Navigation */
.nav-arrows {
  display: none;
  position: fixed;
  top: 50%;
  left: 0;
  right: 0;
  transform: translateY(-50%);
  justify-content: space-between;
  padding: 0 1rem;
  pointer-events: none;
  z-index: 50;
}

.nav-arrow {
  width: 50px;
  height: 50px;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 50%;
  font-size: 2rem;
  color: var(--soft-purple);
  cursor: pointer;
  pointer-events: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.nav-arrow:hover:not(:disabled) {
  background: var(--parchment);
}

.nav-arrow:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.page-indicator {
  position: fixed;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem;
  z-index: 50;
}

.indicator-dot {
  width: 10px;
  height: 10px;
  background: var(--parchment);
  border: 2px solid var(--soft-purple);
  border-radius: 50%;
  cursor: pointer;
  padding: 0;
  transition: all 0.2s ease;
}

.indicator-dot:hover {
  background: var(--coral-light);
}

.indicator-dot.active {
  background: var(--coral);
  border-color: var(--coral);
  transform: scale(1.2);
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.modal-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}

.modal-content {
  width: 100%;
  max-width: 420px;
  background: white;
  border-radius: 20px;
  padding: 1.75rem;
  position: relative;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.visible .modal-content {
  transform: scale(1);
}

.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 32px;
  height: 32px;
  background: var(--parchment);
  border: none;
  border-radius: 50%;
  font-size: 1.5rem;
  color: var(--soft-purple);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-header {
  text-align: center;
  margin-bottom: 1rem;
}

.modal-icon {
  font-size: 2.5rem;
  display: block;
  margin-bottom: 0.5rem;
}

.modal-title {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--deep-purple);
}

.modal-description {
  font-family: var(--font-body);
  font-size: 0.9rem;
  color: #666;
  text-align: center;
  line-height: 1.5;
  margin-bottom: 1.25rem;
}

.api-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.input-group {
  position: relative;
  display: flex;
}

.api-input {
  flex: 1;
  padding: 1rem;
  padding-right: 3rem;
  font-family: monospace;
  font-size: 1rem;
  border: 2px solid var(--parchment);
  border-radius: 12px;
}

.api-input:focus {
  outline: none;
  border-color: var(--soft-purple);
}

.toggle-visibility {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 1.25rem;
  cursor: pointer;
  opacity: 0.6;
}

.modal-actions {
  display: flex;
  gap: 0.75rem;
}

.btn-secondary, .btn-primary {
  flex: 1;
  padding: 0.875rem 1rem;
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
}

.btn-secondary {
  background: var(--parchment);
  border: 2px solid var(--parchment);
  color: var(--soft-purple);
}

.btn-primary {
  background: linear-gradient(135deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  border: none;
  color: white;
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.modal-footer {
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--parchment);
  text-align: center;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  color: #888;
}

.modal-footer a {
  color: var(--coral);
  text-decoration: none;
}

/* Desktop */
@media (min-width: 768px) {
  .book {
    max-width: 550px;
  }

  .nav-arrows {
    display: flex;
  }

  .story-page {
    padding: 1.5rem;
  }
}

@media (min-width: 1024px) {
  .book {
    max-width: 650px;
  }

  .nav-arrows {
    padding: 0 3rem;
  }
}

/* Landscape mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .book {
    aspect-ratio: 4 / 3;
    max-width: 80vh;
  }

  .story-page {
    flex-direction: row;
    padding: 0.75rem;
  }

  .page-image-container {
    flex: 1;
  }

  .page-text-container {
    flex: 1;
  }
}
```

  </style>
</head>
<body>
  <div class="bg-decoration">
    <div class="bg-circle bg-circle-1"></div>
    <div class="bg-circle bg-circle-2"></div>
  </div>

  <!-- PROMPT SCREEN -->

  <div id="prompt-screen" class="screen">
    <div class="prompt-container">
      <div class="logo-container">
        <span class="logo-icon">üìñ</span>
        <h1 class="logo-text">Whimsy Tales</h1>
        <p class="tagline">AI-Powered Rhyming Storybooks</p>
      </div>

```
  <div class="top-buttons">
    <button id="api-key-btn" class="api-key-button" onclick="showModal()">
      <span>üîë</span> Enter OpenAI API Key
    </button>
    <button id="library-btn" class="library-button" onclick="showLibrary()">
      <span>üìö</span> My Library
      <span id="library-count" class="library-count" style="display: none;">0</span>
    </button>
  </div>

  <form class="prompt-form" onsubmit="generateStory(event)">
    <label class="prompt-label" for="story-prompt">What shall your story be about?</label>
    <div class="input-wrapper">
      <textarea id="story-prompt" class="prompt-input" placeholder="A brave little toaster on an epic quest..." rows="3" maxlength="500" oninput="updateCharCount()"></textarea>
      <span id="char-count" class="char-count">0/500</span>
    </div>
    <button type="submit" id="submit-btn" class="submit-button" disabled>
      <span>Create My Story</span>
      <span>‚ú®</span>
    </button>
    <p id="api-hint" class="api-hint">Please add your OpenAI API key to create stories</p>
    <div id="error-message" class="error-message" style="display: none;"></div>
  </form>

  <div class="sample-prompts">
    <p class="sample-label">Need inspiration? Try one of these:</p>
    <div class="sample-list">
      <button class="sample-chip" onclick="useSample(this)">A clumsy dragon who can't stop sneezing</button>
      <button class="sample-chip" onclick="useSample(this)">A penguin who dreams of living in the desert</button>
      <button class="sample-chip" onclick="useSample(this)">A wizard whose spells always go wrong</button>
      <button class="sample-chip" onclick="useSample(this)">A cat who thinks it's a dog</button>
    </div>
  </div>
</div>
```

  </div>

  <!-- LOADING SCREEN -->

  <div id="loading-screen" class="screen hidden">
    <div class="loading-content">
      <div class="loading-book">
        <div class="book-base">
          <div class="loading-page"></div>
          <div class="loading-page"></div>
          <div class="loading-page"></div>
        </div>
      </div>
      <h2 id="loading-message" class="loading-message">Crafting your whimsical tale...</h2>
      <div class="loading-dots">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </div>
    </div>
  </div>

  <!-- BOOK SCREEN -->

  <div id="book-screen" class="screen hidden book-screen">
    <button class="back-button" onclick="goBack()">‚Üê Back</button>
    <button id="save-btn" class="save-button" onclick="toggleSaveStory()">
      <span id="save-icon">üíæ</span> <span id="save-text">Save</span>
    </button>
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
    </div>

```
<div id="book" class="book" onclick="handleBookClick(event)" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
  <div class="book-spine"></div>
  <div id="book-page" class="book-page"></div>
</div>

<div class="nav-arrows">
  <button id="prev-btn" class="nav-arrow" onclick="prevPage()">‚Äπ</button>
  <button id="next-btn" class="nav-arrow" onclick="nextPage()">‚Ä∫</button>
</div>

<div id="page-indicator" class="page-indicator"></div>
```

  </div>

  <!-- API KEY MODAL -->

  <div id="modal" class="modal-overlay" onclick="hideModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="hideModal()">√ó</button>
      <div class="modal-header">
        <span class="modal-icon">üîë</span>
        <h2 class="modal-title">OpenAI API Key</h2>
      </div>
      <p class="modal-description">
        Enter your OpenAI API key to generate stories. Your key is stored only in your browser.
      </p>
      <form class="api-form" onsubmit="saveApiKey(event)">
        <div class="input-group">
          <input type="password" id="api-key-input" class="api-input" placeholder="sk-..." autocomplete="off">
          <button type="button" class="toggle-visibility" onclick="toggleKeyVisibility()">üëÅÔ∏è</button>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="hideModal()">Cancel</button>
          <button type="submit" class="btn-primary" id="save-key-btn">Save Key</button>
        </div>
      </form>
      <div class="modal-footer">
        Need an API key? <a href="https://platform.openai.com/api-keys" target="_blank">Get one from OpenAI ‚Üí</a>
      </div>
    </div>
  </div>

  <!-- LIBRARY SCREEN -->

  <div id="library-screen" class="screen hidden library-screen">
    <div class="library-container">
      <div class="library-header">
        <h2 class="library-title">üìö My Library</h2>
        <button class="library-back" onclick="hideLibrary()">‚Üê Back</button>
      </div>
      <div id="library-content"></div>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->

  <div id="toast" class="toast"></div>

  <script>
    // State
    let apiKey = localStorage.getItem('openai_api_key') || '';
    let story = null;
    let currentPage = 0;
    let totalPages = 0;
    let touchStartX = 0;
    let touchEndX = 0;
    let isAnimating = false;
    let currentStoryId = null; // Track if viewing a saved story
    let isFromLibrary = false; // Track if we came from library

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (apiKey) {
        updateApiKeyUI(true);
      }
      updateLibraryCount();
      document.addEventListener('keydown', handleKeyDown);
    });

    // API Key functions
    function showModal() {
      document.getElementById('api-key-input').value = apiKey;
      document.getElementById('modal').classList.add('visible');
    }

    function hideModal(e) {
      if (!e || e.target === document.getElementById('modal')) {
        document.getElementById('modal').classList.remove('visible');
      }
    }

    function toggleKeyVisibility() {
      const input = document.getElementById('api-key-input');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function saveApiKey(e) {
      e.preventDefault();
      const key = document.getElementById('api-key-input').value.trim();
      if (key) {
        apiKey = key;
        localStorage.setItem('openai_api_key', key);
        updateApiKeyUI(true);
        hideModal();
      }
    }

    function updateApiKeyUI(hasKey) {
      const btn = document.getElementById('api-key-btn');
      const hint = document.getElementById('api-hint');
      const submitBtn = document.getElementById('submit-btn');
      const prompt = document.getElementById('story-prompt');

      if (hasKey) {
        btn.innerHTML = '<span>üîì</span> API Key Set';
        btn.classList.add('has-key');
        hint.style.display = 'none';
        submitBtn.disabled = !prompt.value.trim();
      } else {
        btn.innerHTML = '<span>üîë</span> Enter OpenAI API Key';
        btn.classList.remove('has-key');
        hint.style.display = 'block';
        submitBtn.disabled = true;
      }
    }

    // Prompt functions
    function updateCharCount() {
      const prompt = document.getElementById('story-prompt');
      document.getElementById('char-count').textContent = `${prompt.value.length}/500`;
      document.getElementById('submit-btn').disabled = !apiKey || !prompt.value.trim();
    }

    function useSample(btn) {
      const prompt = document.getElementById('story-prompt');
      prompt.value = btn.textContent;
      updateCharCount();
    }

    // Story generation
    async function generateStory(e) {
      e.preventDefault();
      if (!apiKey) {
        showModal();
        return;
      }

      const prompt = document.getElementById('story-prompt').value.trim();
      if (!prompt) return;

      showScreen('loading');
      hideError();

      try {
        setLoadingMessage('Crafting your whimsical tale...');
        const storyData = await callOpenAI(prompt);

        setLoadingMessage('Painting magical illustrations...');
        const storyWithImages = await generateImages(storyData);

        story = storyWithImages;
        currentPage = 0;
        totalPages = story.pages.length + 2;
        showScreen('book');
        renderBook();
      } catch (err) {
        console.error(err);
        showScreen('prompt');
        showError(err.message || 'Something went wrong. Please try again.');
      }
    }

    async function callOpenAI(prompt) {
      const systemPrompt = `You are a whimsical children's book author who writes humorous rhyming stories. 
Your stories should:
- Be funny and engaging for all ages
- Use AABB or ABAB rhyme schemes consistently
- Have 6-8 short verses/pages (2-4 lines each)
- Include vivid, imaginative imagery
- Have a light-hearted, playful tone
- Include a satisfying ending

CRITICAL: You must also create a consistent visual style guide that will be used for ALL illustrations.

Respond with a JSON object:
{
  "title": "The Story Title",
  "visualStyle": {
    "artStyle": "Describe the specific art style (e.g., 'soft watercolor with bold outlines', 'whimsical gouache painting', 'cute vector illustration style')",
    "colorPalette": "List 4-5 specific colors that dominate the book (e.g., 'warm golden yellows, soft coral pinks, sky blue, cream white, forest green')",
    "characters": {
      "mainCharacter": "Detailed physical description of the main character that stays consistent (species, size, colors, distinguishing features, clothing/accessories)",
      "supportingCharacters": "Descriptions of any recurring supporting characters"
    },
    "settingStyle": "Describe the overall look of backgrounds and environments",
    "moodAndLighting": "Describe the lighting and mood (e.g., 'warm afternoon sunlight, cozy and cheerful atmosphere')"
  },
  "pages": [
    {
      "text": "The rhyming verse",
      "imagePrompt": "Scene-specific description (what's happening, where, character poses/expressions). Do NOT repeat the style info here - just describe the scene."
    }
  ]
}

The visualStyle will be prepended to each image prompt automatically, so each page's imagePrompt should only describe WHAT IS HAPPENING in that specific scene, not the art style or character descriptions.`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `Create a funny rhyming story about: ${prompt}` }
          ],
          temperature: 0.9,
          max_tokens: 2000,
          response_format: { type: 'json_object' }
        })
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || 'Failed to generate story');
      }

      const data = await response.json();
      return JSON.parse(data.choices[0].message.content);
    }

    async function generateImages(storyData) {
      const pages = [...storyData.pages];
      
      // Build the visual style context
      const style = storyData.visualStyle;
      const styleContext = `You are illustrating a children's picture book called "${storyData.title}". 
      
You MUST maintain PERFECT visual consistency across ALL ${pages.length} images in this book.

STYLE GUIDE (use for EVERY image):
- Art Style: ${style.artStyle}
- Color Palette: ${style.colorPalette}
- Main Character: ${style.characters.mainCharacter}
${style.characters.supportingCharacters ? `- Supporting Characters: ${style.characters.supportingCharacters}` : ''}
- Setting Style: ${style.settingStyle}
- Mood/Lighting: ${style.moodAndLighting}

The main character must look IDENTICAL in every single image - same colors, same proportions, same features, same clothing/accessories. This is critical for a cohesive picture book.`;

      // Use Responses API with previous_response_id to maintain conversation context
      let previousResponseId = null;

      for (let i = 0; i < pages.length; i++) {
        setLoadingMessage(`Painting illustration ${i + 1} of ${pages.length}...`);
        
        try {
          // Build the input for this request
          let input;
          if (i === 0) {
            // First image: establish the style
            input = `${styleContext}

Now generate illustration 1 of ${pages.length}.
Scene: ${pages[i].imagePrompt}

Create this image following the style guide exactly. This establishes the visual look for all subsequent images.`;
          } else {
            // Subsequent images: reference previous context
            input = `Generate illustration ${i + 1} of ${pages.length} for this same children's book.

Scene: ${pages[i].imagePrompt}

CRITICAL: The main character and art style must look EXACTLY the same as in the previous ${i} illustration(s). Same character design, same colors, same art style.`;
          }

          const requestBody = {
            model: 'gpt-4o',
            input: input,
            tools: [{ type: 'image_generation' }]
          };

          // Add previous_response_id to maintain conversation context
          if (previousResponseId) {
            requestBody.previous_response_id = previousResponseId;
          }

          const response = await fetch('https://api.openai.com/v1/responses', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify(requestBody)
          });

          if (!response.ok) {
            const err = await response.json();
            console.error('Responses API error:', err);
            
            // Fallback to direct image generation if Responses API fails
            console.log('Falling back to direct image generation...');
            const fallbackUrl = await generateImageFallback(styleContext, pages[i].imagePrompt, i, pages.length);
            pages[i].imageUrl = fallbackUrl;
            continue;
          }

          const data = await response.json();
          
          // Store response ID for next iteration to maintain context
          previousResponseId = data.id;

          // Extract image from the response
          let imageUrl = null;
          
          if (data.output) {
            for (const item of data.output) {
              if (item.type === 'image_generation_call' && item.result) {
                // Image data could be base64 or URL
                if (item.result.startsWith('data:') || item.result.startsWith('http')) {
                  imageUrl = item.result;
                } else {
                  // Assume base64
                  imageUrl = `data:image/png;base64,${item.result}`;
                }
                break;
              }
              // Also check for image content in messages
              if (item.type === 'message' && item.content) {
                for (const content of item.content) {
                  if (content.type === 'image' && content.image) {
                    if (content.image.url) {
                      imageUrl = content.image.url;
                    } else if (content.image.data) {
                      imageUrl = `data:image/png;base64,${content.image.data}`;
                    }
                    break;
                  }
                }
              }
            }
          }

          pages[i].imageUrl = imageUrl;

        } catch (err) {
          console.error(`Image ${i + 1} failed:`, err);
          pages[i].imageUrl = null;
        }
      }

      return { ...storyData, pages };
    }

    // Fallback function using gpt-image-1 directly if Responses API is unavailable
    async function generateImageFallback(styleContext, scenePrompt, pageNum, totalPages) {
      const fullPrompt = `${styleContext}

Page ${pageNum + 1} of ${totalPages}: ${scenePrompt}

Generate a children's book illustration following the style guide exactly.`;

      const response = await fetch('https://api.openai.com/v1/images/generations', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-image-1',
          prompt: fullPrompt,
          n: 1,
          size: '1024x1024',
          quality: 'medium'
        })
      });

      if (!response.ok) {
        throw new Error('Image generation failed');
      }

      const data = await response.json();
      if (data.data && data.data[0]) {
        if (data.data[0].b64_json) {
          return `data:image/png;base64,${data.data[0].b64_json}`;
        } else if (data.data[0].url) {
          return data.data[0].url;
        }
      }
      return null;
    }

    // Removed standalone generateImage function - now handled in generateImages with conversation context

    // Book rendering
    function renderBook() {
      renderPage();
      renderIndicators();
      updateProgress();
      updateNavButtons();
    }

    function renderPage() {
      const pageEl = document.getElementById('book-page');

      if (currentPage === 0) {
        // Cover
        pageEl.innerHTML = `
          <div class="book-page cover-page">
            <span class="cover-decoration tl">‚ú¶</span>
            <span class="cover-decoration tr">‚ú¶</span>
            <span class="cover-decoration bl">‚ú¶</span>
            <span class="cover-decoration br">‚ú¶</span>
            <h1 class="book-title">${story.title}</h1>
            <div class="cover-divider">„Ä∞Ô∏è</div>
            <p class="book-subtitle">A Whimsical Tale</p>
            <p class="tap-hint">Tap or swipe to turn pages</p>
          </div>
        `;
      } else if (currentPage === totalPages - 1) {
        // End
        pageEl.innerHTML = `
          <div class="book-page end-page">
            <span class="end-icon">üåü</span>
            <h2 class="end-title">The End</h2>
            <p class="end-subtitle">We hope you enjoyed this tale!</p>
            <button class="new-story-button" onclick="goBack()">Create Another Story</button>
          </div>
        `;
      } else {
        // Story page
        const page = story.pages[currentPage - 1];
        const imageHtml = page.imageUrl 
          ? `<img src="${page.imageUrl}" alt="Illustration" class="page-image">`
          : `<div class="page-image-placeholder">üé®</div>`;

        pageEl.innerHTML = `
          <div class="book-page story-page">
            <div class="page-image-container">${imageHtml}</div>
            <div class="page-text-container">
              <p class="page-text">${page.text}</p>
            </div>
            <span class="page-number">${currentPage}</span>
          </div>
        `;
      }
    }

    function renderIndicators() {
      const container = document.getElementById('page-indicator');
      container.innerHTML = '';
      for (let i = 0; i < totalPages; i++) {
        const dot = document.createElement('button');
        dot.className = `indicator-dot ${i === currentPage ? 'active' : ''}`;
        dot.onclick = () => goToPage(i);
        container.appendChild(dot);
      }
    }

    function updateProgress() {
      const pct = ((currentPage + 1) / totalPages) * 100;
      document.getElementById('progress-fill').style.width = `${pct}%`;
    }

    function updateNavButtons() {
      document.getElementById('prev-btn').disabled = currentPage === 0;
      document.getElementById('next-btn').disabled = currentPage === totalPages - 1;
    }

    // Navigation
    function goToPage(page) {
      if (isAnimating || page < 0 || page >= totalPages || page === currentPage) return;

      const direction = page > currentPage ? 'right' : 'left';
      animatePageTurn(direction, () => {
        currentPage = page;
        renderBook();
      });
    }

    function nextPage() {
      if (currentPage < totalPages - 1) goToPage(currentPage + 1);
    }

    function prevPage() {
      if (currentPage > 0) goToPage(currentPage - 1);
    }

    function animatePageTurn(direction, callback) {
      isAnimating = true;
      const pageEl = document.getElementById('book-page');
      pageEl.classList.add(`turning-${direction === 'right' ? 'left' : 'right'}`);

      setTimeout(() => {
        callback();
        pageEl.classList.remove('turning-left', 'turning-right');
        pageEl.classList.add(`turning-${direction}`);

        requestAnimationFrame(() => {
          pageEl.classList.remove('turning-left', 'turning-right');
          isAnimating = false;
        });
      }, 300);
    }

    function handleBookClick(e) {
      const rect = e.currentTarget.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      if (clickX < rect.width / 2) {
        prevPage();
      } else {
        nextPage();
      }
    }

    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
    }

    function handleTouchMove(e) {
      touchEndX = e.touches[0].clientX;
    }

    function handleTouchEnd() {
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) nextPage();
        else prevPage();
      }
    }

    function handleKeyDown(e) {
      if (document.getElementById('book-screen').classList.contains('hidden')) return;
      if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault();
        nextPage();
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        prevPage();
      } else if (e.key === 'Escape') {
        goBack();
      }
    }

    // Utility
    function showScreen(name) {
      document.getElementById('prompt-screen').classList.toggle('hidden', name !== 'prompt');
      document.getElementById('loading-screen').classList.toggle('hidden', name !== 'loading');
      document.getElementById('book-screen').classList.toggle('hidden', name !== 'book');
      document.getElementById('library-screen').classList.toggle('hidden', name !== 'library');
      
      // Update save button state when showing book
      if (name === 'book') {
        updateSaveButtonState();
      }
    }

    function setLoadingMessage(msg) {
      document.getElementById('loading-message').textContent = msg;
    }

    function showError(msg) {
      const el = document.getElementById('error-message');
      el.innerHTML = `<span>‚ö†Ô∏è</span> ${msg}`;
      el.style.display = 'flex';
    }

    function hideError() {
      document.getElementById('error-message').style.display = 'none';
    }

    function goBack() {
      if (isFromLibrary) {
        showLibrary();
        isFromLibrary = false;
      } else {
        showScreen('prompt');
      }
      story = null;
      currentStoryId = null;
    }

    // ===== LIBRARY FUNCTIONS =====
    
    function getLibrary() {
      const lib = localStorage.getItem('whimsy_tales_library');
      return lib ? JSON.parse(lib) : [];
    }

    function saveLibrary(library) {
      localStorage.setItem('whimsy_tales_library', JSON.stringify(library));
      updateLibraryCount();
    }

    function updateLibraryCount() {
      const library = getLibrary();
      const countEl = document.getElementById('library-count');
      if (library.length > 0) {
        countEl.textContent = library.length;
        countEl.style.display = 'flex';
      } else {
        countEl.style.display = 'none';
      }
    }

    function generateStoryId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function showLibrary() {
      renderLibrary();
      showScreen('library');
    }

    function hideLibrary() {
      showScreen('prompt');
    }

    function renderLibrary() {
      const library = getLibrary();
      const container = document.getElementById('library-content');

      if (library.length === 0) {
        container.innerHTML = `
          <div class="library-empty">
            <div class="library-empty-icon">üìö</div>
            <h3>No saved stories yet</h3>
            <p>Create a story and tap "Save" to add it to your library!</p>
          </div>
        `;
        return;
      }

      // Sort by date, newest first
      const sorted = [...library].sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));

      container.innerHTML = `
        <div class="library-grid">
          ${sorted.map(item => {
            const coverImage = item.story.pages[0]?.imageUrl;
            const date = new Date(item.savedAt).toLocaleDateString();
            return `
              <div class="library-card" onclick="openSavedStory('${item.id}')">
                ${coverImage 
                  ? `<img src="${coverImage}" alt="${item.story.title}" class="library-card-image">`
                  : `<div class="library-card-placeholder">üìñ</div>`
                }
                <div class="library-card-info">
                  <div class="library-card-title">${item.story.title}</div>
                  <div class="library-card-date">${date}</div>
                </div>
                <button class="library-card-delete" onclick="event.stopPropagation(); deleteStory('${item.id}')" title="Delete story">√ó</button>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function openSavedStory(id) {
      const library = getLibrary();
      const item = library.find(i => i.id === id);
      
      if (item) {
        story = item.story;
        currentStoryId = id;
        currentPage = 0;
        totalPages = story.pages.length + 2;
        isFromLibrary = true;
        showScreen('book');
        renderBook();
      }
    }

    function deleteStory(id) {
      if (!confirm('Are you sure you want to delete this story?')) return;
      
      let library = getLibrary();
      library = library.filter(item => item.id !== id);
      saveLibrary(library);
      renderLibrary();
      showToast('üóëÔ∏è Story deleted');
    }

    function toggleSaveStory() {
      if (!story) return;

      const library = getLibrary();
      
      if (currentStoryId) {
        // Already saved - remove it
        const newLibrary = library.filter(item => item.id !== currentStoryId);
        saveLibrary(newLibrary);
        currentStoryId = null;
        updateSaveButtonState();
        showToast('üìñ Removed from library');
      } else {
        // Not saved - save it
        const id = generateStoryId();
        library.push({
          id: id,
          story: story,
          savedAt: new Date().toISOString()
        });
        saveLibrary(library);
        currentStoryId = id;
        updateSaveButtonState();
        showToast('üíæ Saved to library!');
      }
    }

    function updateSaveButtonState() {
      const saveBtn = document.getElementById('save-btn');
      const saveIcon = document.getElementById('save-icon');
      const saveText = document.getElementById('save-text');
      
      if (currentStoryId) {
        saveBtn.classList.add('saved');
        saveIcon.textContent = '‚úì';
        saveText.textContent = 'Saved';
      } else {
        saveBtn.classList.remove('saved');
        saveIcon.textContent = 'üíæ';
        saveText.textContent = 'Save';
      }
    }

    function isStorySaved() {
      if (!story) return false;
      const library = getLibrary();
      return library.some(item => item.story.title === story.title);
    }

    // Toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');
      
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 2500);
    }
  </script>

</body>
</html>
