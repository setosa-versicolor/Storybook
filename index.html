<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#2d1b4e">
  <meta name="description" content="Generate humorous rhyming stories with AI-powered illustrations">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
  <title>Whimsy Tales - AI Story Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #faf6f1;
      --parchment: #f5ede3;
      --warm-brown: #8b6914;
      --deep-purple: #2d1b4e;
      --soft-purple: #6b4d8a;
      --coral: #e8735f;
      --coral-light: #ffb5a7;
      --sage: #87a878;
      --gold: #d4a853;
      --ink: #2c2416;
      --font-display: 'Abril Fatface', serif;
      --font-body: 'Crimson Pro', serif;
      --font-ui: 'Fredoka', sans-serif;
    }

```
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: var(--font-body);
  background: linear-gradient(135deg, var(--cream) 0%, var(--parchment) 50%, #f8f0e6 100%);
  color: var(--ink);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* Background decoration */
.bg-decoration {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}

.bg-circle {
  position: absolute;
  border-radius: 50%;
  opacity: 0.15;
}

.bg-circle-1 {
  width: 60vw;
  height: 60vw;
  max-width: 600px;
  max-height: 600px;
  background: radial-gradient(circle, var(--coral) 0%, transparent 70%);
  top: -20%;
  right: -10%;
  animation: float 20s ease-in-out infinite;
}

.bg-circle-2 {
  width: 50vw;
  height: 50vw;
  max-width: 500px;
  max-height: 500px;
  background: radial-gradient(circle, var(--soft-purple) 0%, transparent 70%);
  bottom: -15%;
  left: -10%;
  animation: float 25s ease-in-out infinite reverse;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

/* Screens */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: clamp(1rem, 5vw, 2rem);
  z-index: 1;
  transition: opacity 0.4s ease, transform 0.4s ease;
  overflow-y: auto;
}

.screen.hidden {
  opacity: 0;
  pointer-events: none;
  transform: scale(0.95);
}

/* Allow prompt screen to scroll on small screens */
#prompt-screen {
  justify-content: flex-start;
  padding-top: 2rem;
  padding-bottom: 2rem;
}

@media (min-height: 700px) {
  #prompt-screen {
    justify-content: center;
  }
}

/* ===== PROMPT SCREEN ===== */
.prompt-container {
  width: 100%;
  max-width: 550px;
  display: flex;
  flex-direction: column;
  gap: 1.25rem;
}

.logo-container {
  text-align: center;
  margin-bottom: 0.5rem;
}

.logo-icon {
  font-size: 2.5rem;
  animation: float 3s ease-in-out infinite;
  display: inline-block;
}

.logo-text {
  font-family: var(--font-display);
  font-size: clamp(2rem, 8vw, 3rem);
  color: var(--deep-purple);
  text-shadow: 2px 2px 0 var(--coral-light);
}

.tagline {
  font-family: var(--font-ui);
  font-size: 1rem;
  color: var(--soft-purple);
}

.api-key-button {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: var(--parchment);
  border: 2px dashed var(--soft-purple);
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 0.9rem;
  color: var(--soft-purple);
  cursor: pointer;
  transition: all 0.2s ease;
}

.api-key-button:hover {
  background: white;
  border-style: solid;
}

.api-key-button.has-key {
  background: #e8f5e9;
  border-color: var(--sage);
  border-style: solid;
  color: #2e7d32;
}

.top-buttons {
  display: flex;
  gap: 0.75rem;
}

.library-button {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.25rem;
  background: var(--parchment);
  border: 2px solid var(--warm-brown);
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 0.9rem;
  color: var(--warm-brown);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.library-button:hover {
  background: white;
  border-color: var(--gold);
  color: var(--gold);
}

.library-count {
  position: absolute;
  top: -8px;
  right: -8px;
  background: var(--coral);
  color: white;
  font-size: 0.7rem;
  font-weight: 600;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== LIBRARY SCREEN ===== */
.library-screen {
  overflow-y: auto;
  padding-top: 1rem;
  padding-bottom: 2rem;
}

.library-container {
  width: 100%;
  max-width: 600px;
}

.library-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.library-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 6vw, 2rem);
  color: var(--deep-purple);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.library-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.library-btn {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.85rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  color: var(--soft-purple);
  cursor: pointer;
  transition: all 0.2s ease;
}

.library-btn:hover {
  background: var(--parchment);
  border-color: var(--soft-purple);
}

.library-btn.primary {
  background: linear-gradient(135deg, var(--sage) 0%, #6b9b5a 100%);
  border-color: var(--sage);
  color: white;
}

.library-btn.primary:hover {
  filter: brightness(1.1);
}

.library-back {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 1rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  transition: all 0.2s ease;
}

.library-back:hover {
  background: var(--parchment);
}

.library-storage-info {
  width: 100%;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  color: #999;
  text-align: right;
  margin-top: -0.5rem;
  margin-bottom: 0.5rem;
}

/* Hidden file input */
.hidden-input {
  display: none;
}

/* Model selector tabs */
.model-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.25rem;
}

.model-tab {
  flex: 1;
  padding: 0.75rem 0.5rem;
  background: var(--parchment);
  border: 2px solid var(--parchment);
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

.model-tab:hover {
  background: white;
  border-color: var(--soft-purple);
}

.model-tab.active {
  background: white;
  border-color: var(--deep-purple);
  color: var(--deep-purple);
}

.model-tab-icon {
  font-size: 1.5rem;
}

.model-tab-name {
  font-weight: 600;
}

.model-tab-status {
  font-size: 0.7rem;
  opacity: 0.7;
}

.model-tab-status.configured {
  color: var(--sage);
  opacity: 1;
}

.model-panel {
  display: none;
}

.model-panel.active {
  display: block;
}

.model-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.25rem 0.6rem;
  background: var(--parchment);
  border-radius: 20px;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  color: var(--soft-purple);
  margin-left: 0.5rem;
}

.model-badge.openai {
  background: #e8f5e9;
  color: #2e7d32;
}

.model-badge.gemini {
  background: #e3f2fd;
  color: #1565c0;
}

.library-empty {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--soft-purple);
}

.library-empty-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.library-empty h3 {
  font-family: var(--font-display);
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
  color: var(--deep-purple);
}

.library-empty p {
  font-family: var(--font-body);
  font-size: 1rem;
}

.library-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 1rem;
}

.library-card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.library-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.library-card-image {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  background: var(--parchment);
}

.library-card-placeholder {
  width: 100%;
  aspect-ratio: 1;
  background: linear-gradient(145deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3rem;
}

.library-card-info {
  padding: 0.75rem;
}

.library-card-title {
  font-family: var(--font-ui);
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.library-card-date {
  font-family: var(--font-ui);
  font-size: 0.7rem;
  color: #999;
  margin-top: 0.25rem;
}

.library-card-delete {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  width: 28px;
  height: 28px;
  background: rgba(0, 0, 0, 0.6);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.library-card:hover .library-card-delete {
  opacity: 1;
}

.library-card-delete:hover {
  background: var(--coral);
}

/* Save button in book view */
.save-button {
  position: fixed;
  top: 0.75rem;
  right: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.75rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.save-button:hover {
  background: var(--parchment);
}

.save-button.saved {
  background: #e8f5e9;
  border-color: var(--sage);
  color: #2e7d32;
}

/* Toast notification */
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--ink);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.9rem;
  z-index: 2000;
  opacity: 0;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.toast.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.prompt-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.prompt-label {
  font-family: var(--font-display);
  font-size: clamp(1.25rem, 4vw, 1.5rem);
  color: var(--ink);
  text-align: center;
}

.input-wrapper {
  position: relative;
}

.prompt-input {
  width: 100%;
  padding: 1rem;
  font-family: var(--font-body);
  font-size: 1.1rem;
  line-height: 1.5;
  color: var(--ink);
  background: white;
  border: 3px solid var(--parchment);
  border-radius: 16px;
  resize: none;
  transition: all 0.3s ease;
}

.prompt-input:focus {
  outline: none;
  border-color: var(--soft-purple);
  box-shadow: 0 4px 12px rgba(107, 77, 138, 0.15);
}

.char-count {
  position: absolute;
  bottom: 0.5rem;
  right: 1rem;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  color: #999;
}

.length-selector {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.length-label {
  font-family: var(--font-ui);
  font-size: 0.9rem;
  color: var(--soft-purple);
}

.length-options {
  display: flex;
  gap: 0.5rem;
}

.length-option {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  padding: 0.75rem 0.5rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.length-option:hover {
  border-color: var(--soft-purple);
  background: #faf8ff;
}

.length-option.active {
  border-color: var(--deep-purple);
  background: linear-gradient(135deg, #f5f0ff 0%, #ebe0ff 100%);
}

.length-icon {
  font-size: 1.25rem;
}

.length-name {
  font-family: var(--font-ui);
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--ink);
}

.length-desc {
  font-family: var(--font-ui);
  font-size: 0.7rem;
  color: #999;
}

.length-option.active .length-name {
  color: var(--deep-purple);
}

.submit-button {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  padding: 1.25rem 2rem;
  background: linear-gradient(135deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  border: none;
  border-radius: 16px;
  font-family: var(--font-ui);
  font-size: 1.25rem;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(45, 27, 78, 0.3);
}

.submit-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(45, 27, 78, 0.4);
}

.submit-button:disabled {
  background: #ccc;
  cursor: not-allowed;
  box-shadow: none;
}

.api-hint {
  text-align: center;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--coral);
}

/* Enhanced error message styles */
.error-message {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  padding: 1rem;
  background: #fff5f5;
  border: 1px solid #feb2b2;
  border-radius: 12px;
  color: #c53030;
  font-family: var(--font-ui);
  font-size: 0.9rem;
}

.error-main {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.error-details-toggle {
  background: none;
  border: none;
  color: #c53030;
  text-decoration: underline;
  cursor: pointer;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  padding: 0;
  margin-top: 0.25rem;
}

.error-details-toggle:hover {
  color: #9b2c2c;
}

.error-details {
  display: none;
  margin-top: 0.5rem;
  padding: 0.75rem;
  background: #fed7d7;
  border-radius: 8px;
  font-family: monospace;
  font-size: 0.75rem;
  white-space: pre-wrap;
  word-break: break-all;
  max-height: 200px;
  overflow-y: auto;
  text-align: left;
}

.error-details.visible {
  display: block;
}

.error-details-header {
  font-weight: bold;
  margin-bottom: 0.5rem;
  color: #9b2c2c;
}

.sample-prompts {
  margin-top: 0.5rem;
}

.sample-label {
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  text-align: center;
  margin-bottom: 0.75rem;
}

.sample-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
}

.sample-chip {
  padding: 0.4rem 0.8rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 20px;
  font-family: var(--font-body);
  font-size: 0.8rem;
  color: var(--ink);
  cursor: pointer;
  transition: all 0.2s ease;
}

.sample-chip:hover {
  background: var(--coral-light);
  border-color: var(--coral);
  transform: translateY(-2px);
}

/* ===== LOADING SCREEN ===== */
.loading-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2rem;
}

.loading-book {
  width: 120px;
  height: 90px;
  position: relative;
  perspective: 600px;
}

.book-base {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  border-radius: 4px 12px 12px 4px;
  position: relative;
  box-shadow: -5px 5px 15px rgba(0, 0, 0, 0.2);
}

.book-base::before {
  content: '';
  position: absolute;
  left: 0;
  top: 5%;
  bottom: 5%;
  width: 8px;
  background: linear-gradient(90deg, var(--warm-brown) 0%, #a67c1a 50%, var(--warm-brown) 100%);
  border-radius: 2px 0 0 2px;
}

.loading-page {
  position: absolute;
  right: 5px;
  top: 5px;
  bottom: 5px;
  width: calc(100% - 20px);
  background: linear-gradient(90deg, #f5f0e8 0%, #fffef9 100%);
  border-radius: 0 8px 8px 0;
  transform-origin: left center;
  animation: flipPage 1.5s ease-in-out infinite;
}

.loading-page:nth-child(2) { animation-delay: 0.1s; }
.loading-page:nth-child(3) { animation-delay: 0.2s; }

@keyframes flipPage {
  0%, 100% { transform: rotateY(0deg); }
  50% { transform: rotateY(-25deg); }
}

.loading-message {
  font-family: var(--font-display);
  font-size: clamp(1.25rem, 5vw, 1.75rem);
  color: var(--deep-purple);
  text-align: center;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.loading-dots {
  display: flex;
  gap: 0.5rem;
}

.loading-dot {
  width: 10px;
  height: 10px;
  background: var(--coral);
  border-radius: 50%;
  animation: bounce 0.8s ease-in-out infinite;
}

.loading-dot:nth-child(2) { animation-delay: 0.15s; }
.loading-dot:nth-child(3) { animation-delay: 0.3s; }

@keyframes bounce {
  0%, 100% { transform: translateY(-3px); opacity: 0.3; }
  50% { transform: translateY(3px); opacity: 1; }
}

/* ===== BOOK SCREEN ===== */
.book-screen {
  padding: 0.5rem;
}

.back-button {
  position: fixed;
  top: 0.75rem;
  left: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 0.75rem;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 0.85rem;
  color: var(--soft-purple);
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.back-button:hover {
  background: var(--parchment);
}

.progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--parchment);
  z-index: 100;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--coral) 0%, var(--gold) 100%);
  transition: width 0.3s ease;
}

.book {
  position: relative;
  width: 100%;
  max-width: 500px;
  aspect-ratio: 3 / 4;
  margin: auto;
  cursor: pointer;
  -webkit-user-select: none;
  user-select: none;
  touch-action: pan-x;
  perspective: 1500px;
}

.book-spine {
  position: absolute;
  left: 0;
  top: 5%;
  bottom: 5%;
  width: 12px;
  background: linear-gradient(90deg, var(--warm-brown) 0%, #a67c1a 50%, var(--warm-brown) 100%);
  border-radius: 3px 0 0 3px;
  box-shadow: inset -2px 0 4px rgba(0, 0, 0, 0.3);
  z-index: 5;
}

.book-page-container {
  position: absolute;
  inset: 0;
  left: 12px;
  transform-style: preserve-3d;
}

.book-page {
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, #fffef9 0%, #faf8f3 50%, #f5f0e8 100%);
  border-radius: 0 12px 12px 0;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.15), 5px 5px 20px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform-origin: left center;
  transition: transform 0.5s ease-in-out;
  backface-visibility: hidden;
}

.book-page.turning-forward {
  animation: turnPageForward 0.6s ease-in-out forwards;
}

.book-page.turning-backward {
  animation: turnPageBackward 0.6s ease-in-out forwards;
}

@keyframes turnPageForward {
  0% {
    transform: rotateY(0deg);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.15), 5px 5px 20px rgba(0, 0, 0, 0.1);
  }
  50% {
    transform: rotateY(-90deg);
    box-shadow: 20px 0 40px rgba(0, 0, 0, 0.3);
  }
  100% {
    transform: rotateY(-180deg);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.15), 5px 5px 20px rgba(0, 0, 0, 0.1);
  }
}

@keyframes turnPageBackward {
  0% {
    transform: rotateY(0deg);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.15), 5px 5px 20px rgba(0, 0, 0, 0.1);
  }
  50% {
    transform: rotateY(90deg);
    box-shadow: -20px 0 40px rgba(0, 0, 0, 0.3);
  }
  100% {
    transform: rotateY(180deg);
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.15), 5px 5px 20px rgba(0, 0, 0, 0.1);
  }
}

/* Page shadow overlay during turn */
.book-page::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(to right, rgba(0,0,0,0.1) 0%, transparent 20%);
  pointer-events: none;
  border-radius: 0 12px 12px 0;
}

/* Cover page */
.cover-page {
  background: linear-gradient(145deg, var(--deep-purple) 0%, #3d2763 50%, var(--deep-purple) 100%);
  justify-content: center;
  align-items: center;
  padding: 2rem;
  color: white;
}

.cover-decoration {
  position: absolute;
  font-size: 1.5rem;
  color: var(--gold);
  opacity: 0.6;
}

.cover-decoration.tl { top: 1.5rem; left: 1.5rem; }
.cover-decoration.tr { top: 1.5rem; right: 1.5rem; }
.cover-decoration.bl { bottom: 1.5rem; left: 1.5rem; }
.cover-decoration.br { bottom: 1.5rem; right: 1.5rem; }

.book-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 6vw, 2.5rem);
  text-align: center;
  line-height: 1.2;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.cover-divider {
  font-size: 1.5rem;
  margin: 1rem 0;
  opacity: 0.5;
}

.book-subtitle {
  font-family: var(--font-body);
  font-size: 1.1rem;
  font-style: italic;
  opacity: 0.8;
}

.tap-hint {
  position: absolute;
  bottom: 1.5rem;
  left: 0;
  right: 0;
  text-align: center;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  color: rgba(255, 255, 255, 0.5);
  animation: pulse 2s ease-in-out infinite;
}

/* Story page */
.story-page {
  padding: 1rem;
  gap: 0.75rem;
}

.page-image-container {
  flex: 1;
  min-height: 0;
  border-radius: 8px;
  overflow: hidden;
  background: var(--parchment);
}

.page-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.page-image-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--soft-purple);
  opacity: 0.5;
  font-size: 3rem;
}

.page-text-container {
  padding: 0.75rem 0.5rem;
  min-height: 25%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.page-text {
  font-family: var(--font-body);
  font-size: clamp(0.9rem, 3.5vw, 1.15rem);
  line-height: 1.6;
  text-align: center;
  color: var(--ink);
}

.page-number {
  position: absolute;
  bottom: 0.5rem;
  right: 1rem;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  color: var(--soft-purple);
  opacity: 0.5;
}

/* End page */
.end-page {
  background: linear-gradient(145deg, var(--sage) 0%, #6b9c5a 50%, var(--sage) 100%);
  justify-content: center;
  align-items: center;
  padding: 2rem;
  color: white;
  text-align: center;
}

.end-icon {
  font-size: 4rem;
  display: block;
  margin-bottom: 1rem;
  animation: float 3s ease-in-out infinite;
}

.end-title {
  font-family: var(--font-display);
  font-size: clamp(2rem, 8vw, 3rem);
  margin-bottom: 0.5rem;
}

.end-subtitle {
  font-family: var(--font-body);
  font-size: 1.1rem;
  font-style: italic;
  opacity: 0.9;
  margin-bottom: 2rem;
}

.new-story-button {
  padding: 1rem 2rem;
  background: white;
  border: none;
  border-radius: 25px;
  font-family: var(--font-ui);
  font-size: 1rem;
  font-weight: 600;
  color: var(--sage);
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.new-story-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

/* Navigation */
.nav-arrows {
  display: none;
  position: fixed;
  top: 50%;
  left: 0;
  right: 0;
  transform: translateY(-50%);
  justify-content: space-between;
  padding: 0 1rem;
  pointer-events: none;
  z-index: 50;
}

.nav-arrow {
  width: 50px;
  height: 50px;
  background: white;
  border: 2px solid var(--parchment);
  border-radius: 50%;
  font-size: 2rem;
  color: var(--soft-purple);
  cursor: pointer;
  pointer-events: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.nav-arrow:hover:not(:disabled) {
  background: var(--parchment);
}

.nav-arrow:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.page-indicator {
  position: fixed;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem;
  z-index: 50;
}

.indicator-dot {
  width: 10px;
  height: 10px;
  background: var(--parchment);
  border: 2px solid var(--soft-purple);
  border-radius: 50%;
  cursor: pointer;
  padding: 0;
  transition: all 0.2s ease;
}

.indicator-dot:hover {
  background: var(--coral-light);
}

.indicator-dot.active {
  background: var(--coral);
  border-color: var(--coral);
  transform: scale(1.2);
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.modal-overlay.visible {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
}

.modal-content {
  width: 100%;
  max-width: 420px;
  background: white;
  border-radius: 20px;
  padding: 1.75rem;
  position: relative;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.visible .modal-content {
  transform: scale(1);
}

.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 32px;
  height: 32px;
  background: var(--parchment);
  border: none;
  border-radius: 50%;
  font-size: 1.5rem;
  color: var(--soft-purple);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-header {
  text-align: center;
  margin-bottom: 1rem;
}

.modal-icon {
  font-size: 2.5rem;
  display: block;
  margin-bottom: 0.5rem;
}

.modal-title {
  font-family: var(--font-display);
  font-size: 1.5rem;
  color: var(--deep-purple);
}

.modal-description {
  font-family: var(--font-body);
  font-size: 0.9rem;
  color: #666;
  text-align: center;
  line-height: 1.5;
  margin-bottom: 1.25rem;
}

.api-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.input-group {
  position: relative;
  display: flex;
}

.api-input {
  flex: 1;
  padding: 1rem;
  padding-right: 3rem;
  font-family: monospace;
  font-size: 1rem;
  border: 2px solid var(--parchment);
  border-radius: 12px;
}

.api-input:focus {
  outline: none;
  border-color: var(--soft-purple);
}

.toggle-visibility {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 1.25rem;
  cursor: pointer;
  opacity: 0.6;
}

.modal-actions {
  display: flex;
  gap: 0.75rem;
}

.btn-secondary, .btn-primary {
  flex: 1;
  padding: 0.875rem 1rem;
  border-radius: 12px;
  font-family: var(--font-ui);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
}

.btn-secondary {
  background: var(--parchment);
  border: 2px solid var(--parchment);
  color: var(--soft-purple);
}

.btn-primary {
  background: linear-gradient(135deg, var(--deep-purple) 0%, var(--soft-purple) 100%);
  border: none;
  color: white;
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.modal-footer {
  margin-top: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--parchment);
  text-align: center;
  font-family: var(--font-ui);
  font-size: 0.8rem;
  color: #888;
}

.modal-footer a {
  color: var(--coral);
  text-decoration: none;
}

/* Desktop */
@media (min-width: 768px) {
  .book {
    max-width: 550px;
  }

  .nav-arrows {
    display: flex;
  }

  .story-page {
    padding: 1.5rem;
  }
}

@media (min-width: 1024px) {
  .book {
    max-width: 650px;
  }

  .nav-arrows {
    padding: 0 3rem;
  }
}

/* Landscape mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .book {
    aspect-ratio: 4 / 3;
    max-width: 80vh;
  }

  .story-page {
    flex-direction: row;
    padding: 0.75rem;
  }

  .page-image-container {
    flex: 1;
  }

  .page-text-container {
    flex: 1;
  }
}
```

  </style>
</head>
<body>
  <div class="bg-decoration">
    <div class="bg-circle bg-circle-1"></div>
    <div class="bg-circle bg-circle-2"></div>
  </div>

  <!-- PROMPT SCREEN -->

  <div id="prompt-screen" class="screen">
    <div class="prompt-container">
      <div class="logo-container">
        <span class="logo-icon">üìñ</span>
        <h1 class="logo-text">Whimsy Tales</h1>
        <p class="tagline">AI-Powered Rhyming Storybooks</p>
      </div>

```
  <div class="top-buttons">
    <button id="api-key-btn" class="api-key-button" onclick="showModal()">
      <span>üîë</span> Enter OpenAI API Key
    </button>
    <button id="library-btn" class="library-button" onclick="showLibrary()">
      <span>üìö</span> My Library
      <span id="library-count" class="library-count" style="display: none;">0</span>
    </button>
  </div>

  <form class="prompt-form" onsubmit="generateStory(event)">
    <label class="prompt-label" for="story-prompt">What shall your story be about?</label>
    <div class="input-wrapper">
      <textarea id="story-prompt" class="prompt-input" placeholder="A brave little toaster on an epic quest..." rows="3" maxlength="500" oninput="updateCharCount()"></textarea>
      <span id="char-count" class="char-count">0/500</span>
    </div>
    <div class="length-selector">
      <label class="length-label">Story length:</label>
      <div class="length-options">
        <button type="button" class="length-option" data-length="short" onclick="selectLength(this)">
          <span class="length-icon">üìÑ</span>
          <span class="length-name">Short</span>
          <span class="length-desc">3-4 pages</span>
        </button>
        <button type="button" class="length-option active" data-length="medium" onclick="selectLength(this)">
          <span class="length-icon">üìë</span>
          <span class="length-name">Medium</span>
          <span class="length-desc">5-6 pages</span>
        </button>
        <button type="button" class="length-option" data-length="long" onclick="selectLength(this)">
          <span class="length-icon">üìö</span>
          <span class="length-name">Long</span>
          <span class="length-desc">7-8 pages</span>
        </button>
      </div>
    </div>
    <button type="submit" id="submit-btn" class="submit-button" disabled>
      <span>Create My Story</span>
      <span>‚ú®</span>
    </button>
    <p id="api-hint" class="api-hint">Please add your OpenAI API key to create stories</p>
    <div id="error-message" class="error-message" style="display: none;"></div>
  </form>

  <div class="sample-prompts">
    <p class="sample-label">Need inspiration? Try one of these:</p>
    <div class="sample-list">
      <button type="button" class="sample-chip" onclick="useSample(this)">A clumsy dragon who can't stop sneezing</button>
      <button type="button" class="sample-chip" onclick="useSample(this)">A penguin who dreams of living in the desert</button>
      <button type="button" class="sample-chip" onclick="useSample(this)">A wizard whose spells always go wrong</button>
      <button type="button" class="sample-chip" onclick="useSample(this)">A cat who thinks it's a dog</button>
    </div>
  </div>
</div>
```

  </div>

  <!-- LOADING SCREEN -->

  <div id="loading-screen" class="screen hidden">
    <div class="loading-content">
      <div class="loading-book">
        <div class="book-base">
          <div class="loading-page"></div>
          <div class="loading-page"></div>
          <div class="loading-page"></div>
        </div>
      </div>
      <h2 id="loading-message" class="loading-message">Crafting your whimsical tale...</h2>
      <div class="loading-dots">
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
        <span class="loading-dot"></span>
      </div>
    </div>
  </div>

  <!-- BOOK SCREEN -->

  <div id="book-screen" class="screen hidden book-screen">
    <button class="back-button" onclick="goBack()">‚Üê Back</button>
    <button id="save-btn" class="save-button" onclick="toggleSaveStory()">
      <span id="save-icon">üíæ</span> <span id="save-text">Save</span>
    </button>
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
    </div>

```
<div id="book" class="book" onclick="handleBookClick(event)" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
  <div class="book-spine"></div>
  <div class="book-page-container">
    <div id="book-page" class="book-page"></div>
  </div>
</div>

<div class="nav-arrows">
  <button id="prev-btn" class="nav-arrow" onclick="prevPage()">‚Äπ</button>
  <button id="next-btn" class="nav-arrow" onclick="nextPage()">‚Ä∫</button>
</div>

<div id="page-indicator" class="page-indicator"></div>
```

  </div>

  <!-- API KEY MODAL -->

  <div id="modal" class="modal-overlay" onclick="hideModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="hideModal()">√ó</button>
      <div class="modal-header">
        <span class="modal-icon">üîë</span>
        <h2 class="modal-title">API Settings</h2>
      </div>
      <p class="modal-description">
        Choose your AI provider and enter your API key. Keys are stored only in your browser.
      </p>

```
  <!-- Model Tabs -->
  <div class="model-tabs">
    <button type="button" class="model-tab active" onclick="switchModelTab('openai')" id="tab-openai">
      <span class="model-tab-icon">ü§ñ</span>
      <span class="model-tab-name">OpenAI</span>
      <span class="model-tab-status" id="status-openai">Not configured</span>
    </button>
    <button type="button" class="model-tab" onclick="switchModelTab('gemini')" id="tab-gemini">
      <span class="model-tab-icon">üçå</span>
      <span class="model-tab-name">Gemini</span>
      <span class="model-tab-status" id="status-gemini">Not configured</span>
    </button>
  </div>

  <!-- OpenAI Panel -->
  <div id="panel-openai" class="model-panel active">
    <form class="api-form" onsubmit="saveApiKey(event, 'openai')">
      <div class="input-group">
        <input type="password" id="openai-key-input" class="api-input" placeholder="sk-..." autocomplete="off">
        <button type="button" class="toggle-visibility" onclick="toggleKeyVisibility('openai-key-input')">üëÅÔ∏è</button>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="hideModal()">Cancel</button>
        <button type="submit" class="btn-primary">Save &amp; Use OpenAI</button>
      </div>
    </form>
    <div class="modal-footer">
      Need an API key? <a href="https://platform.openai.com/api-keys" target="_blank">Get one from OpenAI ‚Üí</a>
    </div>
  </div>

  <!-- Gemini Panel -->
  <div id="panel-gemini" class="model-panel">
    <form class="api-form" onsubmit="saveApiKey(event, 'gemini')">
      <div class="input-group">
        <input type="password" id="gemini-key-input" class="api-input" placeholder="AIza..." autocomplete="off">
        <button type="button" class="toggle-visibility" onclick="toggleKeyVisibility('gemini-key-input')">üëÅÔ∏è</button>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="hideModal()">Cancel</button>
        <button type="submit" class="btn-primary">Save &amp; Use Gemini</button>
      </div>
    </form>
    <div class="modal-footer">
      Need an API key? <a href="https://aistudio.google.com/apikey" target="_blank">Get one from Google AI Studio ‚Üí</a>
    </div>
  </div>
</div>
```

  </div>

  <!-- LIBRARY SCREEN -->

  <div id="library-screen" class="screen hidden library-screen">
    <div class="library-container">
      <div class="library-header">
        <h2 class="library-title">üìö My Library</h2>
        <div class="library-actions">
          <button class="library-btn" onclick="exportLibrary()" title="Export all stories">
            üì§ Export
          </button>
          <button class="library-btn primary" onclick="document.getElementById('import-input').click()" title="Import stories">
            üì• Import
          </button>
          <input type="file" id="import-input" class="hidden-input" accept=".json" onchange="importLibrary(event)">
          <button class="library-back" onclick="hideLibrary()">‚Üê Back</button>
        </div>
      </div>
      <div id="library-storage-info" class="library-storage-info"></div>
      <div id="library-content"></div>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->

  <div id="toast" class="toast"></div>

  <script>
    // State
    let openaiKey = localStorage.getItem('openai_api_key') || '';
    let geminiKey = localStorage.getItem('gemini_api_key') || '';
    let activeProvider = localStorage.getItem('active_provider') || 'openai'; // 'openai' or 'gemini'
    let story = null;
    let currentPage = 0;
    let totalPages = 0;
    let touchStartX = 0;
    let touchEndX = 0;
    let isAnimating = false;
    let currentStoryId = null;
    let isFromLibrary = false;
    let lastErrorDetails = null;
    let storyLength = 'medium'; // 'short', 'medium', 'long'
    let geminiChatSession = null; // For maintaining Gemini conversation context

    // Helper to get current API key
    function getActiveApiKey() {
      return activeProvider === 'gemini' ? geminiKey : openaiKey;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize IndexedDB first
      try {
        await initDB();
        await migrateFromLocalStorage();
      } catch (e) {
        console.error('Failed to initialize database:', e);
      }
      
      updateApiKeyUI();
      updateModalStatus();
      updateLibraryCount();
      document.addEventListener('keydown', handleKeyDown);
    });

    // API Key functions
    function showModal() {
      document.getElementById('openai-key-input').value = openaiKey;
      document.getElementById('gemini-key-input').value = geminiKey;
      switchModelTab(activeProvider);
      updateModalStatus();
      document.getElementById('modal').classList.add('visible');
      // Focus the appropriate input after a brief delay for the animation
      setTimeout(() => {
        const inputId = activeProvider === 'gemini' ? 'gemini-key-input' : 'openai-key-input';
        document.getElementById(inputId).focus();
      }, 100);
    }

    function hideModal(e) {
      // If called with an event (from overlay click), only close if clicking the overlay itself
      if (e && e.type === 'click' && e.target !== document.getElementById('modal')) {
        return;
      }
      document.getElementById('modal').classList.remove('visible');
    }

    function switchModelTab(provider) {
      // Update tab active states
      document.getElementById('tab-openai').classList.toggle('active', provider === 'openai');
      document.getElementById('tab-gemini').classList.toggle('active', provider === 'gemini');
      
      // Update panel visibility
      document.getElementById('panel-openai').classList.toggle('active', provider === 'openai');
      document.getElementById('panel-gemini').classList.toggle('active', provider === 'gemini');
    }

    function updateModalStatus() {
      const openaiStatus = document.getElementById('status-openai');
      const geminiStatus = document.getElementById('status-gemini');
      
      if (openaiKey) {
        openaiStatus.textContent = activeProvider === 'openai' ? '\u2713 Active' : '\u2713 Ready';
        openaiStatus.classList.add('configured');
      } else {
        openaiStatus.textContent = 'Not configured';
        openaiStatus.classList.remove('configured');
      }
      
      if (geminiKey) {
        geminiStatus.textContent = activeProvider === 'gemini' ? '\u2713 Active' : '\u2713 Ready';
        geminiStatus.classList.add('configured');
      } else {
        geminiStatus.textContent = 'Not configured';
        geminiStatus.classList.remove('configured');
      }
    }

    function toggleKeyVisibility(inputId) {
      const input = document.getElementById(inputId);
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function saveApiKey(e, provider) {
      e.preventDefault();
      const inputId = provider === 'gemini' ? 'gemini-key-input' : 'openai-key-input';
      const key = document.getElementById(inputId).value.trim();
      
      if (key) {
        if (provider === 'gemini') {
          geminiKey = key;
          localStorage.setItem('gemini_api_key', key);
        } else {
          openaiKey = key;
          localStorage.setItem('openai_api_key', key);
        }
        
        // Set this provider as active
        activeProvider = provider;
        localStorage.setItem('active_provider', provider);
        
        updateApiKeyUI();
        updateModalStatus();
        hideModal();
      }
    }

    function updateApiKeyUI() {
      const btn = document.getElementById('api-key-btn');
      const hint = document.getElementById('api-hint');
      const submitBtn = document.getElementById('submit-btn');
      const prompt = document.getElementById('story-prompt');
      const hasKey = getActiveApiKey();

      if (hasKey) {
        const providerName = activeProvider === 'gemini' ? 'Gemini' : 'OpenAI';
        const providerIcon = activeProvider === 'gemini' ? '\uD83C\uDF4C' : '\uD83E\uDD16';
        btn.innerHTML = '<span>' + providerIcon + '</span> ' + providerName + ' Active';
        btn.classList.add('has-key');
        hint.style.display = 'none';
        submitBtn.disabled = !prompt.value.trim();
      } else {
        btn.innerHTML = '<span>&#128273;</span> Set Up API Key';
        btn.classList.remove('has-key');
        hint.textContent = 'Please add an API key to create stories';
        hint.style.display = 'block';
        submitBtn.disabled = true;
      }
    }

    // Prompt functions
    function updateCharCount() {
      const prompt = document.getElementById('story-prompt');
      document.getElementById('char-count').textContent = `${prompt.value.length}/500`;
      document.getElementById('submit-btn').disabled = !getActiveApiKey() || !prompt.value.trim();
    }

    function useSample(btn) {
      const prompt = document.getElementById('story-prompt');
      prompt.value = btn.textContent;
      updateCharCount();
    }

    function selectLength(btn) {
      document.querySelectorAll('.length-option').forEach(el => el.classList.remove('active'));
      btn.classList.add('active');
      storyLength = btn.dataset.length;
    }

    // Story generation
    async function generateStory(e) {
      e.preventDefault();
      if (!getActiveApiKey()) {
        showModal();
        return;
      }

      const prompt = document.getElementById('story-prompt').value.trim();
      if (!prompt) return;

      showScreen('loading');
      hideError();
      geminiChatSession = null; // Reset Gemini chat session for new story

      try {
        setLoadingMessage('Crafting your whimsical tale...');
        const storyData = activeProvider === 'gemini' 
          ? await callGeminiForStory(prompt)
          : await callOpenAI(prompt);

        setLoadingMessage('Painting magical illustrations...');
        const storyWithImages = activeProvider === 'gemini'
          ? await generateImagesWithGemini(storyData)
          : await generateImages(storyData);

        story = storyWithImages;
        currentPage = 0;
        totalPages = story.pages.length + 2;
        showScreen('book');
        renderBook();
      } catch (err) {
        console.error(err);
        showScreen('prompt');
        showError(err.message || 'Something went wrong. Please try again.', err.details || null);
      }
    }

    async function callOpenAI(prompt) {
      const lengthConfig = {
        short: { pages: '3-4', desc: 'short' },
        medium: { pages: '5-6', desc: 'medium-length' },
        long: { pages: '7-8', desc: 'longer' }
      };
      const config = lengthConfig[storyLength] || lengthConfig.medium;

      const systemPrompt = `You are a whimsical children's book author who writes humorous rhyming stories. 
Your stories should:
- Be funny and engaging for all ages
- Use AABB or ABAB rhyme schemes consistently
- Have exactly ${config.pages} short verses/pages (2-4 lines each) - this is a ${config.desc} story
- Include vivid, imaginative imagery
- Have a light-hearted, playful tone
- Include a satisfying ending

CRITICAL: You must also create a consistent visual style guide that will be used for ALL illustrations.

Respond with a JSON object:
{
  "title": "The Story Title",
  "visualStyle": {
    "artStyle": "Describe the specific art style (e.g., 'soft watercolor with bold outlines', 'whimsical gouache painting', 'cute vector illustration style')",
    "colorPalette": "List 4-5 specific colors that dominate the book (e.g., 'warm golden yellows, soft coral pinks, sky blue, cream white, forest green')",
    "characters": {
      "mainCharacter": "Detailed physical description of the main character that stays consistent (species, size, colors, distinguishing features, clothing/accessories)",
      "supportingCharacters": "Descriptions of any recurring supporting characters"
    },
    "settingStyle": "Describe the overall look of backgrounds and environments",
    "moodAndLighting": "Describe the lighting and mood (e.g., 'warm afternoon sunlight, cozy and cheerful atmosphere')"
  },
  "pages": [
    {
      "text": "The rhyming verse",
      "imagePrompt": "Scene-specific description (what's happening, where, character poses/expressions). Do NOT repeat the style info here - just describe the scene."
    }
  ]
}

The visualStyle will be prepended to each image prompt automatically, so each page's imagePrompt should only describe WHAT IS HAPPENING in that specific scene, not the art style or character descriptions.`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${openaiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: `Create a funny rhyming story about: ${prompt}` }
          ],
          temperature: 0.9,
          max_tokens: 2000,
          response_format: { type: 'json_object' }
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
        const error = new Error(errorData.error?.message || `API Error: ${response.status}`);
        error.details = {
          status: response.status,
          statusText: response.statusText,
          endpoint: 'OpenAI Chat Completions',
          response: errorData,
          timestamp: new Date().toISOString()
        };
        throw error;
      }

      const data = await response.json();
      return JSON.parse(data.choices[0].message.content);
    }

    async function generateImages(storyData) {
      const pages = [...storyData.pages];
      
      const style = storyData.visualStyle;
      const styleContext = `You are illustrating a children's book. Here is the visual style guide you MUST follow for ALL illustrations:

ART STYLE: ${style.artStyle}
COLOR PALETTE: ${style.colorPalette}
MAIN CHARACTER: ${style.characters.mainCharacter}
${style.characters.supportingCharacters ? `SUPPORTING CHARACTERS: ${style.characters.supportingCharacters}` : ''}
SETTING STYLE: ${style.settingStyle}
MOOD/LIGHTING: ${style.moodAndLighting}

You will be creating ${pages.length} illustrations for this book. Each illustration MUST maintain perfect visual consistency with all others - same character designs, same art style, same color palette throughout.`;

      let previousResponseId = null;

      for (let i = 0; i < pages.length; i++) {
        setLoadingMessage(`Painting illustration ${i + 1} of ${pages.length}...`);
        try {
          const scenePrompt = `Draw page ${i + 1} of ${pages.length}: ${pages[i].imagePrompt}`;
          const result = await generateImageWithResponses(styleContext, scenePrompt, previousResponseId, i === 0);
          pages[i].imageUrl = result.imageUrl;
          previousResponseId = result.responseId;
        } catch (err) {
          console.error(`Image ${i} failed:`, err);
          pages[i].imageUrl = null;
          pages[i].imageError = err.details || { message: err.message };
        }
      }

      return { ...storyData, pages };
    }

    async function generateImageWithResponses(styleContext, scenePrompt, previousResponseId, isFirst) {
      const requestBody = {
        model: 'gpt-4o',
        tools: [{ type: 'image_generation' }],
        tool_choice: { type: 'image_generation' }
      };

      // First request includes the full style context
      if (isFirst) {
        requestBody.input = `${styleContext}\n\n${scenePrompt}`;
      } else {
        // Subsequent requests reference the previous response for context
        requestBody.input = scenePrompt;
        if (previousResponseId) {
          requestBody.previous_response_id = previousResponseId;
        }
      }

      const response = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${openaiKey}`
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
        const error = new Error(errorData.error?.message || `Responses API Error: ${response.status}`);
        error.details = {
          status: response.status,
          statusText: response.statusText,
          endpoint: 'OpenAI Responses API (Image Generation)',
          response: errorData,
          timestamp: new Date().toISOString()
        };
        throw error;
      }

      const data = await response.json();
      
      // Extract the image from the response
      const imageOutput = data.output?.find(item => item.type === 'image_generation_call');
      if (!imageOutput || !imageOutput.result) {
        throw new Error('No image was generated in the response');
      }

      // The result is base64 encoded - convert to data URL
      const base64Image = imageOutput.result;
      const imageUrl = `data:image/png;base64,${base64Image}`;

      return {
        imageUrl: imageUrl,
        responseId: data.id
      };
    }

    // ===== GEMINI API FUNCTIONS =====

    async function callGeminiForStory(prompt) {
      const lengthConfig = {
        short: { pages: '3-4', desc: 'short' },
        medium: { pages: '5-6', desc: 'medium-length' },
        long: { pages: '7-8', desc: 'longer' }
      };
      const config = lengthConfig[storyLength] || lengthConfig.medium;

      const systemInstruction = `You are a whimsical children's book author who writes humorous rhyming stories. 
Your stories should:
- Be funny and engaging for all ages
- Use AABB or ABAB rhyme schemes consistently
- Have exactly ${config.pages} short verses/pages (2-4 lines each) - this is a ${config.desc} story
- Include vivid, imaginative imagery
- Have a light-hearted, playful tone
- Include a satisfying ending

CRITICAL: You must also create a consistent visual style guide that will be used for ALL illustrations.

Respond with ONLY a valid JSON object (no markdown, no code fences):
{
  "title": "The Story Title",
  "visualStyle": {
    "artStyle": "Describe the specific art style",
    "colorPalette": "List 4-5 specific colors that dominate the book",
    "characters": {
      "mainCharacter": "Detailed physical description of the main character",
      "supportingCharacters": "Descriptions of any recurring supporting characters"
    },
    "settingStyle": "Describe the overall look of backgrounds and environments",
    "moodAndLighting": "Describe the lighting and mood"
  },
  "pages": [
    {
      "text": "The rhyming verse",
      "imagePrompt": "Scene-specific description"
    }
  ]
}`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          system_instruction: {
            parts: [{ text: systemInstruction }]
          },
          contents: [{
            parts: [{ text: `Create a funny rhyming story about: ${prompt}` }]
          }],
          generationConfig: {
            temperature: 0.9,
            maxOutputTokens: 2000,
            responseMimeType: 'application/json'
          }
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
        const error = new Error(errorData.error?.message || `Gemini API Error: ${response.status}`);
        error.details = {
          status: response.status,
          statusText: response.statusText,
          endpoint: 'Gemini generateContent',
          response: errorData,
          timestamp: new Date().toISOString()
        };
        throw error;
      }

      const data = await response.json();
      
      // Extract text from Gemini response
      const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!textContent) {
        throw new Error('No content in Gemini response');
      }

      // Parse JSON, handling potential markdown code fences
      let jsonStr = textContent.trim();
      if (jsonStr.startsWith('```')) {
        jsonStr = jsonStr.replace(/^```(?:json)?\n?/, '').replace(/\n?```$/, '');
      }
      
      return JSON.parse(jsonStr);
    }

    async function generateImagesWithGemini(storyData) {
      const pages = [...storyData.pages];
      const style = storyData.visualStyle;
      
      // Build the style context for consistent illustrations
      const styleContext = `You are illustrating a children's book. Here is the visual style guide you MUST follow for ALL illustrations:

ART STYLE: ${style.artStyle}
COLOR PALETTE: ${style.colorPalette}
MAIN CHARACTER: ${style.characters.mainCharacter}
${style.characters.supportingCharacters ? `SUPPORTING CHARACTERS: ${style.characters.supportingCharacters}` : ''}
SETTING STYLE: ${style.settingStyle}
MOOD/LIGHTING: ${style.moodAndLighting}

You will be creating ${pages.length} illustrations for this book. Each illustration MUST maintain perfect visual consistency with all others - same character designs, same art style, same color palette throughout.`;

      // We'll maintain conversation history for consistency
      let conversationHistory = [];

      for (let i = 0; i < pages.length; i++) {
        setLoadingMessage(`Painting illustration ${i + 1} of ${pages.length}...`);
        try {
          const scenePrompt = `Draw page ${i + 1} of ${pages.length}: ${pages[i].imagePrompt}`;
          const result = await generateGeminiImage(styleContext, scenePrompt, conversationHistory, i === 0);
          pages[i].imageUrl = result.imageUrl;
          conversationHistory = result.history;
        } catch (err) {
          console.error(`Gemini Image ${i} failed:`, err);
          pages[i].imageUrl = null;
          pages[i].imageError = err.details || { message: err.message };
        }
      }

      return { ...storyData, pages };
    }

    async function generateGeminiImage(styleContext, scenePrompt, previousHistory, isFirst) {
      // Build the conversation contents
      let contents = [];
      
      if (isFirst) {
        // First request includes full style context
        contents.push({
          role: 'user',
          parts: [{ text: `${styleContext}\n\n${scenePrompt}` }]
        });
      } else {
        // Continue the conversation with previous history for consistency
        contents = [...previousHistory];
        contents.push({
          role: 'user',
          parts: [{ text: scenePrompt }]
        });
      }

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-image-generation:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contents: contents,
          generationConfig: {
            responseModalities: ['image', 'text'],
            imageSafetySettings: 'block_low_and_above'
          }
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error' } }));
        const error = new Error(errorData.error?.message || `Gemini Image API Error: ${response.status}`);
        error.details = {
          status: response.status,
          statusText: response.statusText,
          endpoint: 'Gemini Image Generation (Nano Banana)',
          response: errorData,
          timestamp: new Date().toISOString()
        };
        throw error;
      }

      const data = await response.json();
      
      // Find the image part in the response
      const parts = data.candidates?.[0]?.content?.parts || [];
      const imagePart = parts.find(p => p.inlineData?.mimeType?.startsWith('image/'));
      
      if (!imagePart) {
        throw new Error('No image was generated in the Gemini response');
      }

      const base64Image = imagePart.inlineData.data;
      const mimeType = imagePart.inlineData.mimeType;
      const imageUrl = `data:${mimeType};base64,${base64Image}`;

      // Update conversation history for next request (maintains context)
      const newHistory = [...contents];
      newHistory.push({
        role: 'model',
        parts: parts
      });

      return {
        imageUrl: imageUrl,
        history: newHistory
      };
    }

    // Enhanced error display
    function showError(msg, details = null) {
      const el = document.getElementById('error-message');
      lastErrorDetails = details;
      
      let html = `<div class="error-main"><span>&#9888;&#65039;</span> ${escapeHtml(msg)}</div>`;
      
      if (details) {
        html += `
          <button type="button" class="error-details-toggle" onclick="toggleErrorDetails()">
            Show error details [+]
          </button>
          <div id="error-details" class="error-details">
            <div class="error-details-header">API Error Details:</div>
            <div><strong>Endpoint:</strong> ${escapeHtml(details.endpoint || 'Unknown')}</div>
            <div><strong>Status:</strong> ${escapeHtml(String(details.status || 'N/A'))} ${escapeHtml(details.statusText || '')}</div>
            <div><strong>Time:</strong> ${escapeHtml(details.timestamp || new Date().toISOString())}</div>
            <div><strong>Full Response:</strong></div>
            <pre>${escapeHtml(JSON.stringify(details.response, null, 2))}</pre>

```
      </div>
    `;
  }
  
  el.innerHTML = html;
  el.style.display = 'flex';
}

function toggleErrorDetails() {
  const detailsEl = document.getElementById('error-details');
  const toggleBtn = document.querySelector('.error-details-toggle');
  
  if (detailsEl.classList.contains('visible')) {
    detailsEl.classList.remove('visible');
    toggleBtn.textContent = 'Show error details [+]';
  } else {
    detailsEl.classList.add('visible');
    toggleBtn.textContent = 'Hide error details [-]';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function hideError() {
  document.getElementById('error-message').style.display = 'none';
  lastErrorDetails = null;
}

// Book rendering
function renderBook() {
  renderPage();
  renderIndicators();
  updateProgress();
  updateNavButtons();
}

function renderPage() {
  const pageEl = document.getElementById('book-page');

  // Reset classes
  pageEl.className = 'book-page';

  if (currentPage === 0) {
    pageEl.classList.add('cover-page');
    pageEl.innerHTML = `
      <span class="cover-decoration tl">&#10022;</span>
      <span class="cover-decoration tr">&#10022;</span>
      <span class="cover-decoration bl">&#10022;</span>
      <span class="cover-decoration br">&#10022;</span>
      <h1 class="book-title">${story.title}</h1>
      <div class="cover-divider">~~~~~</div>
      <p class="book-subtitle">A Whimsical Tale</p>
      <p class="tap-hint">Tap or swipe to turn pages</p>
    `;
  } else if (currentPage === totalPages - 1) {
    pageEl.classList.add('end-page');
    pageEl.innerHTML = `
      <span class="end-icon">&#11088;</span>
      <h2 class="end-title">The End</h2>
      <p class="end-subtitle">We hope you enjoyed this tale!</p>
      <button class="new-story-button" onclick="goBack()">Create Another Story</button>
    `;
  } else {
    pageEl.classList.add('story-page');
    const page = story.pages[currentPage - 1];
    const imageHtml = page.imageUrl 
      ? `<img src="${page.imageUrl}" alt="Illustration" class="page-image">`
      : `<div class="page-image-placeholder">&#127912;<br><small style="font-size: 0.5em;">Image failed</small></div>`;

    pageEl.innerHTML = `
      <div class="page-image-container">${imageHtml}</div>
      <div class="page-text-container">
        <p class="page-text">${page.text}</p>
      </div>
      <span class="page-number">${currentPage}</span>
    `;
  }
}

function renderIndicators() {
  const container = document.getElementById('page-indicator');
  container.innerHTML = '';
  for (let i = 0; i < totalPages; i++) {
    const dot = document.createElement('button');
    dot.className = `indicator-dot ${i === currentPage ? 'active' : ''}`;
    dot.onclick = () => goToPage(i);
    container.appendChild(dot);
  }
}

function updateProgress() {
  const pct = ((currentPage + 1) / totalPages) * 100;
  document.getElementById('progress-fill').style.width = `${pct}%`;
}

function updateNavButtons() {
  document.getElementById('prev-btn').disabled = currentPage === 0;
  document.getElementById('next-btn').disabled = currentPage === totalPages - 1;
}

// Navigation
function goToPage(page) {
  if (isAnimating || page < 0 || page >= totalPages || page === currentPage) return;

  const direction = page > currentPage ? 'right' : 'left';
  animatePageTurn(direction, () => {
    currentPage = page;
    renderBook();
  });
}

function nextPage() {
  if (currentPage < totalPages - 1) goToPage(currentPage + 1);
}

function prevPage() {
  if (currentPage > 0) goToPage(currentPage - 1);
}

function animatePageTurn(direction, callback) {
  isAnimating = true;
  const pageEl = document.getElementById('book-page');
  
  // Add the appropriate turning class
  const turnClass = direction === 'right' ? 'turning-forward' : 'turning-backward';
  pageEl.classList.add(turnClass);

  // At the halfway point of animation, swap the content
  setTimeout(() => {
    callback();
  }, 300);

  // When animation completes, clean up
  setTimeout(() => {
    pageEl.classList.remove('turning-forward', 'turning-backward');
    pageEl.style.transform = '';
    isAnimating = false;
  }, 600);
}

function handleBookClick(e) {
  const rect = e.currentTarget.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  if (clickX < rect.width / 2) {
    prevPage();
  } else {
    nextPage();
  }
}

function handleTouchStart(e) {
  touchStartX = e.touches[0].clientX;
}

function handleTouchMove(e) {
  touchEndX = e.touches[0].clientX;
}

function handleTouchEnd() {
  const diff = touchStartX - touchEndX;
  if (Math.abs(diff) > 50) {
    if (diff > 0) nextPage();
    else prevPage();
  }
}

function handleKeyDown(e) {
  if (document.getElementById('book-screen').classList.contains('hidden')) return;
  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    nextPage();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    prevPage();
  } else if (e.key === 'Escape') {
    goBack();
  }
}

// Utility
function showScreen(name) {
  document.getElementById('prompt-screen').classList.toggle('hidden', name !== 'prompt');
  document.getElementById('loading-screen').classList.toggle('hidden', name !== 'loading');
  document.getElementById('book-screen').classList.toggle('hidden', name !== 'book');
  document.getElementById('library-screen').classList.toggle('hidden', name !== 'library');
  
  if (name === 'book') {
    updateSaveButtonState();
  }
}

function setLoadingMessage(msg) {
  document.getElementById('loading-message').textContent = msg;
}

function goBack() {
  if (isFromLibrary) {
    showLibrary();
    isFromLibrary = false;
  } else {
    showScreen('prompt');
  }
  story = null;
  currentStoryId = null;
}

// ===== INDEXEDDB LIBRARY FUNCTIONS =====

const DB_NAME = 'whimsy_tales_db';
const DB_VERSION = 1;
const STORE_NAME = 'stories';
let db = null;

// Initialize IndexedDB
function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const database = event.target.result;
      if (!database.objectStoreNames.contains(STORE_NAME)) {
        const store = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
        store.createIndex('savedAt', 'savedAt', { unique: false });
      }
    };
  });
}

// Migrate from localStorage to IndexedDB (one-time)
async function migrateFromLocalStorage() {
  const oldData = localStorage.getItem('whimsy_tales_library');
  if (oldData) {
    try {
      const library = JSON.parse(oldData);
      if (library.length > 0) {
        for (const item of library) {
          await addStoryToDB(item);
        }
        localStorage.removeItem('whimsy_tales_library');
        console.log('Migrated', library.length, 'stories from localStorage to IndexedDB');
      }
    } catch (e) {
      console.error('Migration failed:', e);
    }
  }
}

// Get all stories from IndexedDB
function getLibrary() {
  return new Promise((resolve, reject) => {
    if (!db) {
      resolve([]);
      return;
    }
    const transaction = db.transaction(STORE_NAME, 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    
    request.onsuccess = () => resolve(request.result || []);
    request.onerror = () => reject(request.error);
  });
}

// Add a story to IndexedDB
function addStoryToDB(item) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('Database not initialized'));
      return;
    }
    const transaction = db.transaction(STORE_NAME, 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.put(item);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// Delete a story from IndexedDB
function deleteStoryFromDB(id) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('Database not initialized'));
      return;
    }
    const transaction = db.transaction(STORE_NAME, 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.delete(id);
    
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// Get a single story by ID
function getStoryById(id) {
  return new Promise((resolve, reject) => {
    if (!db) {
      resolve(null);
      return;
    }
    const transaction = db.transaction(STORE_NAME, 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(id);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

async function updateLibraryCount() {
  try {
    const library = await getLibrary();
    const countEl = document.getElementById('library-count');
    if (library.length > 0) {
      countEl.textContent = library.length;
      countEl.style.display = 'flex';
    } else {
      countEl.style.display = 'none';
    }
  } catch (e) {
    console.error('Error updating library count:', e);
  }
}

function generateStoryId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function showLibrary() {
  renderLibrary();
  showScreen('library');
}

function hideLibrary() {
  showScreen('prompt');
}

async function renderLibrary() {
  const container = document.getElementById('library-content');
  const storageInfo = document.getElementById('library-storage-info');
  
  try {
    const library = await getLibrary();
    
    // Update storage info
    if (library.length > 0) {
      const totalSize = new Blob([JSON.stringify(library)]).size;
      const sizeStr = totalSize > 1024 * 1024 
        ? (totalSize / (1024 * 1024)).toFixed(1) + ' MB'
        : (totalSize / 1024).toFixed(1) + ' KB';
      storageInfo.textContent = library.length + ' stories - ' + sizeStr + ' used';
    } else {
      storageInfo.textContent = '';
    }

    if (library.length === 0) {
      container.innerHTML = `
        <div class="library-empty">
          <div class="library-empty-icon">&#128218;</div>
          <h3>No saved stories yet</h3>
          <p>Create a story and tap "Save" to add it to your library!</p>
        </div>
      `;
      return;
    }

    const sorted = [...library].sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));

    container.innerHTML = `
      <div class="library-grid">
        ${sorted.map(item => {
          const coverImage = item.story.pages[0]?.imageUrl;
          const date = new Date(item.savedAt).toLocaleDateString();
          return `
            <div class="library-card" onclick="openSavedStory('${item.id}')">
              ${coverImage 
                ? `<img src="${coverImage}" alt="${item.story.title}" class="library-card-image">`
                : `<div class="library-card-placeholder">&#128214;</div>`
              }
              <div class="library-card-info">
                <div class="library-card-title">${item.story.title}</div>
                <div class="library-card-date">${date}</div>
              </div>
              <button class="library-card-delete" onclick="event.stopPropagation(); deleteStory('${item.id}')" title="Delete story">&#215;</button>
            </div>
          `;
        }).join('')}
      </div>
    `;
  } catch (e) {
    console.error('Error rendering library:', e);
    container.innerHTML = `
      <div class="library-empty">
        <div class="library-empty-icon">&#9888;&#65039;</div>
        <h3>Error loading library</h3>
        <p>Please try refreshing the page.</p>
      </div>
    `;
  }
}

async function openSavedStory(id) {
  try {
    const item = await getStoryById(id);
    
    if (item) {
      story = item.story;
      currentStoryId = id;
      currentPage = 0;
      totalPages = story.pages.length + 2;
      isFromLibrary = true;
      showScreen('book');
      renderBook();
    }
  } catch (e) {
    console.error('Error opening story:', e);
    showToast('Error opening story');
  }
}

async function deleteStory(id) {
  if (!confirm('Are you sure you want to delete this story?')) return;
  
  try {
    await deleteStoryFromDB(id);
    await updateLibraryCount();
    renderLibrary();
    showToast('\uD83D\uDDD1\uFE0F Story deleted');
  } catch (e) {
    console.error('Error deleting story:', e);
    showToast('Error deleting story');
  }
}

async function toggleSaveStory() {
  if (!story) return;

  try {
    if (currentStoryId) {
      await deleteStoryFromDB(currentStoryId);
      currentStoryId = null;
      updateSaveButtonState();
      await updateLibraryCount();
      showToast('\uD83D\uDCD6 Removed from library');
    } else {
      const id = generateStoryId();
      await addStoryToDB({
        id: id,
        story: story,
        savedAt: new Date().toISOString()
      });
      currentStoryId = id;
      updateSaveButtonState();
      await updateLibraryCount();
      showToast('\uD83D\uDCBE Saved to library!');
    }
  } catch (e) {
    console.error('Error saving story:', e);
    showToast('Error saving story');
  }
}

// ===== IMPORT/EXPORT FUNCTIONS =====

async function exportLibrary() {
  try {
    const library = await getLibrary();
    
    if (library.length === 0) {
      showToast('No stories to export');
      return;
    }

    const exportData = {
      version: 1,
      exportedAt: new Date().toISOString(),
      stories: library
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'whimsy-tales-library-' + new Date().toISOString().slice(0, 10) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('\uD83D\uDCE4 Library exported!');
  } catch (e) {
    console.error('Export failed:', e);
    showToast('Export failed');
  }
}

async function importLibrary(event) {
  const file = event.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const data = JSON.parse(text);
    
    let stories = [];
    
    // Handle both new format (with version) and old format (array)
    if (data.version && data.stories) {
      stories = data.stories;
    } else if (Array.isArray(data)) {
      stories = data;
    } else {
      throw new Error('Invalid file format');
    }

    if (stories.length === 0) {
      showToast('No stories found in file');
      return;
    }

    // Get existing library to check for duplicates
    const existing = await getLibrary();
    const existingIds = new Set(existing.map(s => s.id));
    
    let imported = 0;
    let skipped = 0;

    for (const item of stories) {
      // Validate story structure
      if (!item.story || !item.story.title || !item.story.pages) {
        skipped++;
        continue;
      }

      // Generate new ID if duplicate or missing
      if (!item.id || existingIds.has(item.id)) {
        item.id = generateStoryId();
      }

      // Ensure savedAt exists
      if (!item.savedAt) {
        item.savedAt = new Date().toISOString();
      }

      await addStoryToDB(item);
      existingIds.add(item.id);
      imported++;
    }

    await updateLibraryCount();
    renderLibrary();
    
    if (skipped > 0) {
      showToast('\uD83D\uDCE5 Imported ' + imported + ' stories (' + skipped + ' skipped)');
    } else {
      showToast('\uD83D\uDCE5 Imported ' + imported + ' stories!');
    }
  } catch (e) {
    console.error('Import failed:', e);
    showToast('Import failed - invalid file');
  }

  // Reset file input
  event.target.value = '';
}

function updateSaveButtonState() {
  const saveBtn = document.getElementById('save-btn');
  const saveIcon = document.getElementById('save-icon');
  const saveText = document.getElementById('save-text');
  
  if (currentStoryId) {
    saveBtn.classList.add('saved');
    saveIcon.textContent = '\u2713';
    saveText.textContent = 'Saved';
  } else {
    saveBtn.classList.remove('saved');
    saveIcon.textContent = '\uD83D\uDCBE';
    saveText.textContent = 'Save';
  }
}

async function isStorySaved() {
  if (!story) return false;
  try {
    const library = await getLibrary();
    return library.some(item => item.story.title === story.title);
  } catch (e) {
    return false;
  }
}

// Toast notification
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('visible');
  
  setTimeout(() => {
    toast.classList.remove('visible');
  }, 2500);
}
```

  </script>
</body>
</html>
